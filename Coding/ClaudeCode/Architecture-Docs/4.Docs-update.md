# 統合プロンプト：技術仕様書 & 変更履歴管理

システムの詳細な技術仕様書を作成し、変更履歴を体系的に整理してください。既存ドキュメントの構造を尊重し、継続的な更新を前提とした構成にします。

## STEP 1: 既存技術文書の探索と分析

### 1.1 既存文書の発見
```bash
# 技術仕様関連ドキュメントの特定
serena find-files --pattern="*spec*|*design*|*technical*|*architecture*|CHANGELOG*|MIGRATION*"
serena analyze-existing-tech-docs --categorize-by-type
serena extract-doc-ownership --identify-maintainers
```

### 1.2 変更履歴の分析
```bash
# Git履歴とタグの分析
serena analyze-git-history --semantic-versioning --detailed
serena extract-version-tags --compare-changes
serena identify-breaking-changes --impact-analysis
serena track-dependency-evolution --security-updates
```

### 1.3 文書配置戦略の決定
```bash
# プロジェクト固有の慣例に合わせた配置
serena determine-spec-doc-location --follow-existing-patterns
# 候補: /docs/specs/, /technical-docs/, /design/, /specifications/
```

## STEP 2: 技術仕様書の生成・更新

### 2.1 システム設計の詳細分析
```bash
serena analyze-design-patterns --comprehensive --anti-patterns
serena extract-architectural-decisions --rationale-included
serena analyze-performance-characteristics --bottlenecks
serena map-security-implementations --threat-model
serena analyze-data-architecture --consistency-patterns
```

### 2.2 非機能要件の抽出
```bash
serena extract-performance-requirements --from-monitoring
serena identify-scalability-constraints --current-limits
serena analyze-reliability-patterns --failure-modes
serena extract-security-requirements --compliance-check
```

## STEP 3: 変更履歴・マイグレーション記録

### 3.1 体系的な変更ログ生成
```bash
serena generate-changelog --conventional-commits --auto-categorize
serena extract-breaking-changes --migration-impact
serena analyze-dependency-updates --security-implications
serena document-configuration-changes --environment-impact
```

### 3.2 マイグレーション手順の作成
```bash
serena generate-migration-guide --version-specific --rollback-included
serena create-upgrade-scripts --automated-where-possible
serena validate-migration-path --test-scenarios
```

## 出力構成（.tmp内作業→確定配置・既存ファイル名保持）

### A. .tmp内での技術仕様書セット（既存ファイル優先更新）

#### 1. .tmp内でのメイン技術仕様書更新・作成
```bash
# 既存ファイル名パターンに応じた.tmp内更新戦略
if [ -f ".tmp/tech-work/original/TECHNICAL.md" ]; then
    serena enhance-technical-spec ".tmp/tech-work/original/TECHNICAL.md" --preserve-structure --add-missing-sections --output=".tmp/tech-work/TECHNICAL-enhanced.md"
elif [ -f ".tmp/tech-work/original/technical-spec.md" ]; then
    serena update-technical-spec ".tmp/tech-work/original/technical-spec.md" --comprehensive-enhancement --output=".tmp/tech-work/technical-spec-enhanced.md"
elif [ -f ".tmp/tech-work/original/DESIGN.md" ]; then
    serena migrate-design-to-tech-spec ".tmp/tech-work/original/DESIGN.md" --preserve-design-decisions --output=".tmp/tech-work/TECHNICAL.md"
else
    # 新規作成
    serena create-technical-overview ".tmp/tech-work/" --from-analysis --output="technical-overview.md"
fi
```

#### 2. .tmp内での分野別仕様書更新・補完
```bash
# パフォーマンス仕様の.tmp内処理
if [ -f ".tmp/tech-work/original/performance.md" ] || [ -f ".tmp/tech-work/original/PERFORMANCE.md" ]; then
    serena update-performance-spec ".tmp/tech-work/original/performance*.md" --preserve-benchmarks --add-requirements --output=".tmp/tech-work/performance-enhanced.md"
else
    serena create-performance-spec ".tmp/tech-work/" --from-analysis --output="performance.md"
fi

# セキュリティ仕様の.tmp内処理
if [ -f ".tmp/tech-work/original/security.md" ] || [ -f ".tmp/tech-work/original/SECURITY.md" ]; then
    serena update-security-spec ".tmp/tech-work/original/security*.md" --preserve-policies --enhance-threat-model --output=".tmp/tech-work/security-enhanced.md"
else
    serena create-security-spec ".tmp/tech-work/" --from-analysis --output="security.md"
fi

# データ設計仕様の.tmp内処理
if [ -f ".tmp/tech-work/original/data-design.md" ] || [ -f ".tmp/tech-work/original/database.md" ]; then
    serena update-data-spec ".tmp/tech-work/original/data*.md" --preserve-schema --enhance-rationale --output=".tmp/tech-work/data-design-enhanced.md"
else
    serena create-data-design-spec ".tmp/tech-work/" --from-analysis --output="data-design.md"
fi
```

### B. .tmp内での変更管理ドキュメント（既存ファイル保持・強化）

#### 1. .tmp内でのCHANGELOG.md統一・更新
```bash
# 既存CHANGELOG系ファイルの.tmp内統一・更新
if [ -f ".tmp/changelog-work/CHANGELOG.md" ]; then
    serena enhance-changelog ".tmp/changelog-work/CHANGELOG.md" --format-standardization --semantic-versioning --output=".tmp/changelog-work/CHANGELOG-enhanced.md"
elif [ -f ".tmp/changelog-work/HISTORY.md" ]; then
    serena migrate-history-to-changelog ".tmp/changelog-work/HISTORY.md" --preserve-content --format-upgrade --output=".tmp/changelog-work/CHANGELOG.md"
elif [ -f ".tmp/changelog-work/original/RELEASES.md" ]; then
    serena convert-releases-to-changelog ".tmp/changelog-work/original/RELEASES.md" --structure-improvement --output=".tmp/changelog-work/CHANGELOG.md"
else
    # Git履歴から新規生成
    serena generate-changelog-from-git ".tmp/changelog-work/analysis" --conventional-commits --output=".tmp/changelog-work/CHANGELOG.md"
fi
```

#### 2. .tmp内での詳細変更履歴フォルダ構築
```bash
# 既存の変更履歴関連フォルダの.tmp内活用
if [ -d ".tmp/changelog-work/original/migration/" ]; then
    serena enhance-migration-folder ".tmp/changelog-work/original/migration/" --preserve-existing-scripts --output-dir=".tmp/changelog-work/migration-enhanced"
elif [ -d ".tmp/changelog-work/original/docs/changes/" ]; then
    serena enhance-changes-folder ".tmp/changelog-work/original/docs/changes/" --organize-by-type --output-dir=".tmp/changelog-work/changes-enhanced"
else
    # 新規作成
    serena create-changes-structure ".tmp/changelog-work/changes/" --from-analysis
fi
```

## STEP 4: .tmp内成果物の確認・承認

### 4.1 .tmp内品質チェック・既存ファイル整合性確認
```bash
# .tmp内で生成された技術仕様書の品質確認
serena validate-tech-specs ".tmp/tech-work/" --completeness --accuracy --consistency
serena check-spec-implementation-alignment ".tmp/tech-work/" --code-comparison
serena validate-performance-claims ".tmp/tech-work/" --against-monitoring

# 変更履歴の品質確認
serena validate-changelog-format ".tmp/changelog-work/CHANGELOG-enhanced.md" --conventional-commits
serena check-migration-completeness ".tmp/changelog-work/" --version-coverage
serena verify-breaking-change-documentation ".tmp/changelog-work/" --impact-analysis

# 既存ファイルとの差分・改善点確認
serena show-tech-spec-improvements ".tmp/tech-work/" --before-after-comparison
serena show-changelog-improvements ".tmp/changelog-work/" --format-enhancement
```

### 4.2 中間承認プロセス
```bash
echo "=== 技術仕様書更新結果確認 ==="
echo "📊 技術仕様: $(ls .tmp/tech-work/*enhanced.md | wc -l) ファイル更新"
echo "📋 新規作成: $(ls .tmp/tech-work/*.md | grep -v enhanced | wc -l) ファイル"
echo ""
echo "=== 変更履歴統一結果確認 ==="
echo "📝 CHANGELOG統一: $(serena check-changelog-format '.tmp/changelog-work/CHANGELOG-enhanced.md')"
echo "🚀 マイグレーション: $(ls .tmp/changelog-work/migration*/ | wc -l) バージョン対応"
echo ""
echo "承認して本配置を実行しますか？ [y/N]"
read approval

if [[ $approval == "y" || $approval == "Y" ]]; then
    echo "✅ 承認されました。本配置を実行します。"
    serena proceed-to-tech-spec-deployment
else
    echo "⏸️ .tmp内で作業を継続します。"
fi
```

## STEP 5: .tmp→本番配置・クリーンアップ

### 5.1 既存ファイル名保持での配置実行
```bash
# 技術仕様書の既存ファイル名保持配置
serena deploy-tech-specs --source=".tmp/tech-work/" --destination="." --preserve-existing-names --backup-original
serena deploy-changelog --source=".tmp/changelog-work/CHANGELOG-enhanced.md" --destination="CHANGELOG.md" --backup-original

# 新規作成された詳細変更履歴の配置
serena deploy-changes-structure ".tmp/changelog-work/" --destination="." --preserve-existing-structure

# マイグレーション実行ファイルの配置
serena deploy-migration-scripts ".tmp/changelog-work/" --destination="." --preserve-existing-scripts
```

### 5.2 配置ログ・クリーンアップ
```bash
# 配置結果の記録
serena log-tech-spec-deployment --changes-summary --enhancement-metrics
echo "📊 技術仕様: $(serena count-enhanced-sections) セクション強化"
echo "📝 CHANGELOG: $(serena count-changelog-entries) エントリー統一"
echo "🚀 マイグレーション: $(serena count-migration-versions) バージョン対応"
echo "📚 新規作成: $(serena list-newly-created-tech-files)"

# .tmpクリーンアップ（作業履歴保持）
serena archive-tech-spec-work --source=".tmp/" --destination=".tmp/archive/tech-spec-$(date +%Y%m%d-%H%M)"
serena cleanup-tmp-workspace --keep-successful-archive

echo "✅ 技術仕様書・変更履歴管理更新完了"
echo "📁 作業履歴: .tmp/archive/tech-spec-$(date +%Y%m%d-%H%M)/"
```

## 実行時の動的判断

### 既存仕様書の統合
```bash
# 散在する技術文書を発見・統合
serena merge-scattered-specs --preserve-important-details
serena consolidate-architecture-docs --remove-duplicates
serena update-cross-references --fix-broken-links
```

### 変更履歴の再構築
```bash
# 既存のCHANGELOGがある場合
if [ -f "CHANGELOG.md" ]; then
    serena enhance-existing-changelog --semantic-format
    serena extract-migration-info --separate-detailed-guides
fi
```

### ADR（Architecture Decision Record）の生成
```bash
# 重要な技術判断をADRとして文書化
serena extract-architectural-decisions --from-comments --from-commit-messages
serena generate-adr-template --project-specific
```

## 品質保証・継続的更新

### 1. 技術仕様の精度確認
```bash
serena validate-spec-accuracy --compare-implementation
serena check-performance-claims --against-monitoring
serena verify-security-specifications --penetration-test-results
```

### 2. 変更履歴の自動維持
```bash
# CI/CDパイプラインとの統合
serena setup-auto-changelog --conventional-commits
serena configure-breaking-change-detection --api-compatibility
serena enable-migration-validation --automated-testing
```

### 3. ドキュメント同期の自動化
```bash
serena setup-spec-sync --code-comment-extraction
serena configure-doc-validation --on-merge-request
serena enable-outdated-doc-detection --quarterly-review
```

## メンテナンス戦略

### 定期レビューの設定
```markdown
## ドキュメント更新スケジュール

| 種類 | 頻度 | 責任者 |
|------|------|--------|
| 技術仕様概要 | 四半期 | テックリード |
| 詳細仕様 | 機能リリース時 | 開発チーム |
| 変更履歴 | リリース時 | リリース担当 |
| マイグレーション | メジャーバージョン | アーキテクト |
```

このプロンプトにより、既存プロジェクト構造に適応した包括的な技術仕様書と変更履歴管理システムを構築できます。
