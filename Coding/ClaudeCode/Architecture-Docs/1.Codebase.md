# 統合プロンプト：コードベース分析 & アーキテクチャ図生成

あなたは40年のコーディング経験を持つシニアアーキテクトです。プロジェクトの既存ドキュメント構造を探索し、コードベース分析とアーキテクチャ図を一括で生成・更新してください。

## STEP 1: 既存ドキュメント構造の探索

### 1.1 プロジェクト構造の発見
```bash
# プロジェクト全体の構造を把握
serena list-files --recursive --include-hidden
serena analyze-directory-structure

# 既存ドキュメントフォルダを特定
serena find-directories --pattern="doc*|Doc*|documentation|specs|guides"
serena scan-markdown-files --recursive
```

### 1.2 既存ドキュメントの分析
```bash
# 既存ドキュメントの内容と構造を分析
serena analyze-existing-docs --categorize
serena extract-doc-metadata --find-outdated
serena map-doc-relationships
```

### 1.3 ドキュメント配置戦略の決定
発見された構造に基づき、以下のルールで配置先を決定：
- 既存の `/docs`, `/doc`, `/documentation` フォルダがあれば使用
- なければ `/docs` を新規作成
- 言語別フォルダ（`/docs/ja`, `/docs/en`）があれば適切に配置

## STEP 2: コードベース分析の実行

### 2.1 技術スタック・依存関係の分析
```bash
serena analyze-dependencies --deep-scan
serena identify-tech-stack --versions
serena calculate-metrics --complexity --maintainability --technical-debt
serena analyze-code-quality --standards=enterprise
```

### 2.2 アーキテクチャパターンの識別
```bash
serena identify-patterns --architectural --design-patterns
serena analyze-layer-violations
serena extract-architectural-decisions
serena analyze-security-implementations
```

## STEP 3: アーキテクチャ図の生成・更新

### 3.1 既存図の検証と更新
```bash
# 既存のアーキテクチャ図を特定
serena find-architecture-diagrams --formats="png,svg,mermaid,draw.io"
serena validate-diagram-accuracy --compare-with-code

# 既存図の更新 or 新規生成を判断
serena determine-update-strategy --preserve-custom-elements
```

### 3.2 包括的アーキテクチャ図セットの生成
```bash
# C4モデルに基づく段階的図表生成
serena generate-c4-diagrams --all-levels --format=mermaid
serena create-deployment-diagram --current-infrastructure
serena generate-data-flow-diagram --include-external-services
serena create-security-architecture --trust-boundaries
```

## 出力構成（.tmp内作業→確定配置）

### A. .tmp内での分析結果レポート作成
既存ファイルをベースに.tmp内で安全に更新：

**既存ファイル更新の.tmp内プロセス**：
```bash
# 1. 既存分析ファイルがあれば.tmp/workingにコピー
if [ -f "docs/analysis/codebase-analysis.md" ]; then
    cp "docs/analysis/codebase-analysis.md" ".tmp/working/codebase-analysis.md"
    serena enhance-existing-analysis ".tmp/working/codebase-analysis.md" --preserve-structure
elif [ -f "analysis.md" ]; then
    cp "analysis.md" ".tmp/working/analysis.md"
    serena enhance-existing-analysis ".tmp/working/analysis.md" --preserve-structure
else
    serena create-analysis-report ".tmp/working/codebase-analysis.md" --from-scratch
fi

# 2. .tmp内での内容更新・確認
serena update-analysis-content ".tmp/working/" --add-missing-sections --preserve-important
serena validate-analysis-quality ".tmp/working/" --completeness-check
```

### B. .tmp内でのアーキテクチャ図セット作成
**既存ファイル・フォルダの.tmp内での優先的更新**：

#### 既存ファイルパターンの.tmp内検出・更新
```bash
# 既存アーキテクチャファイルの.tmp内更新
if [ -f ".tmp/original/architecture.md" ]; then
    cp ".tmp/original/architecture.md" ".tmp/working/architecture.md"
    serena update-file ".tmp/working/architecture.md" --preserve-structure --enhance-content
elif [ -f ".tmp/original/docs/architecture.md" ]; then
    mkdir -p ".tmp/working/docs"
    cp ".tmp/original/docs/architecture.md" ".tmp/working/docs/architecture.md"
    serena update-file ".tmp/working/docs/architecture.md" --preserve-structure --enhance-content
else
    # 既存フォルダ構造に合わせて.tmp内に新規作成
    target_dir=$(serena find-best-architecture-dir --existing-preference --workspace=".tmp")
    serena create-file "${target_dir}/overview.md"
fi

# .tmp内での図表ファイル管理
serena organize-diagrams --workspace=".tmp/working" --preserve-existing-names
serena generate-missing-diagrams --workspace=".tmp/working" --complement-existing
```

## STEP 4: 中間確認・品質チェック（.tmp内）

### 4.1 .tmp内成果物の確認
```bash
# .tmp内で生成されたファイルの品質確認
serena validate-tmp-documents --workspace=".tmp/working" --comprehensive
serena check-link-integrity --workspace=".tmp/working" --internal-external
serena preview-documents --workspace=".tmp/working" --interactive

# 既存ファイルとの比較・差分確認
serena compare-with-original --original=".tmp/original" --working=".tmp/working" --show-diff
```

### 4.2 承認・確定判断
```bash
# 中間成果の確認・承認プロセス
echo "=== .tmp内生成ファイルの確認 ==="
ls -la .tmp/working/
echo "=== 承認後に本配置を実行しますか？ [y/N] ==="
read approval

if [[ $approval == "y" || $approval == "Y" ]]; then
    serena proceed-to-final-placement
else
    echo "作業を.tmp内で継続します。必要に応じて調整後、再実行してください。"
fi
```

## STEP 5: 確定配置・クリーンアップ

### 5.1 .tmp→本番配置の実行
```bash
# 既存ファイル名を保持した配置
serena deploy-from-tmp --source=".tmp/working" --destination="." --preserve-existing-names
serena update-existing-files --from-tmp --backup-original

# 配置ログの記録
serena log-deployment --changes-summary --file-mappings
```

### 5.2 .tmpクリーンアップ・保持
```bash
# 成功時のクリーンアップ（オプション）
serena cleanup-tmp --keep-successful-run --archive-analysis
# または分析結果保持
serena archive-tmp-results --date-stamp --compress

echo "✅ アーキテクチャ分析・図表生成完了"
echo "📁 作業履歴: .tmp/archive/$(date +%Y%m%d-%H%M)/"
echo "📋 変更されたファイル: $(serena list-updated-files)"
```

### C. 既存ドキュメントの更新ログ
**`{docs_folder}/updates/architecture-update-log.md`**
```markdown
# アーキテクチャドキュメント更新ログ

## [日付] - 分析・図表の全面更新
- **更新されたファイル**: [リスト]
- **新規作成ファイル**: [リスト]  
- **削除されたファイル**: [リスト]
- **主な変更点**: [概要]
```

## 実行時の動的判断

### 既存ドキュメントの扱い
```bash
# 既存ファイルが存在する場合の判断ロジック
if [ -f "docs/architecture.md" ]; then
    serena compare-with-current --suggest-merge-strategy
    # → 既存内容を保持しつつ更新 or 完全置換を提案
fi
```

### ファイル命名規則の適応
```bash
# プロジェクトの既存命名規則を検出・適用
serena detect-naming-conventions --docs-only
serena adapt-file-names --follow-existing-pattern
```

## 品質保証

### 1. 図表の精度確認
```bash
serena validate-architecture-accuracy --compare-implementations
serena check-diagram-consistency --cross-reference
```

### 2. ドキュメント構造の検証  
```bash
serena validate-doc-structure --accessibility --navigation
serena check-internal-links --fix-broken
```

### 3. 既存ワークフローとの統合
```bash
serena integrate-with-ci --update-doc-pipeline
serena setup-auto-validation --on-code-changes
```

このプロンプトにより、プロジェクト固有のドキュメント構造を尊重しつつ、包括的な分析と図表生成を一括で実行できます。
